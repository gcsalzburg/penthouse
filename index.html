<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1">
		<title>üå°Ô∏è penthouse</title>
		<link rel="stylesheet" href="styles.css">
		<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha256-pasqAKBDmFT4eHoN2ndd6lN370kFiGUFyTiUHWhU7k8=" crossorigin="anonymous"></script>
		<script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0/dist/Chart.bundle.min.js"></script>
	</head>
	<body>
		<main>
			<div class="chart_wrapper">
					<canvas id="myChart"></canvas>
			</div>
		</main>
		<script>

		// Container for temperature data
		var temp_json;

		// Fetch data
		getCORS('https://mqtt.designedbycave.co.uk/temps/', function(request){
			var data = request.currentTarget.response || request.target.responseText;
						
			// Get first 50 temperature pairs
			temp_json = JSON.parse(data).slice(0,100);

			// Create map function to get x,y values from temperature and timestamp
			var points = temp_json.map(function(e) {
				return {
					x: new Date(e.ts*1000),
					y: e.value
				};
			});

			// Update graph with temperature data
			chart.data.datasets[0].data = points;
			chart.update();
		});

		// Create graph with appropriate formatting
		var ctx = document.getElementById('myChart').getContext('2d');
		var config = {
			type: 'scatter',
			data: {
				datasets: [{
					label: 'Temp Line',
					fill: false,
					pointRadius: 4,
					pointBorderWidth: 0,
					pointBackgroundColor: 'rgba(255,255,255,1)',
					showLine: true,
					borderColor: 'rgba(255,255,255,1)',
					borderWidth: 2,
					cubicInterpolationMode: 'monotone',
				}]
			},
			options: {
				animation: {
					duration: 0,
				},
				legend: {
					display: false,
				},
				scales: {
					yAxes: [{
						type: 'linear',
						ticks: {
							suggestedMin: 20,
							suggestedMax: 40,
							fontColor: 'rgba(255,255,255,0.7)',
							fontFamily: 'Open Sans',
							fontSize: 16,
							padding: 15,
							callback: function(value, index, values){
                     	return value + '¬∞';
                    	},
						},
						gridLines: {
							color: 'rgba(255,255,255,0.5)',
							lineWidth: 1,
							drawBorder: false,
						}
					}],
					xAxes: [{
						type: 'time',
						time: {
							unit: 'hour'
						},
						gridLines: {
							color: 'rgba(255,255,255,0.5)',
							lineWidth: 1,
							drawBorder: false,
						},
						ticks: {
							fontColor: 'rgba(255,255,255,0.7)',
							fontFamily: 'Open Sans',
							fontSize: 16,
							padding: 15,
						}
					}],
				},
			}
		};

		// Initiate chart
		var chart = new Chart(ctx, config);

		// CORS function from https://plainjs.com/javascript/ajax/making-cors-ajax-get-requests-54/
		function getCORS(url, success) {
			var xhr = new XMLHttpRequest();
			if (!('withCredentials' in xhr)) xhr = new XDomainRequest(); // fix IE8/9
			xhr.open('GET', url);
			xhr.onload = success;
			xhr.send();
			return xhr;
		}
		</script>
			
	</body>

</html>