<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1">
		<title>üå°Ô∏è penthouse</title>
		<link rel="stylesheet" href="styles.css">
		<script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0/dist/Chart.bundle.min.js"></script>
	</head>
	<body>
		<main>
			<div class="chart_wrapper">
					<canvas id="myChart"></canvas>
         </div>
         <div class="date_title" id="date_title">loading...</div>
		</main>
		<script>

		// Container for temperature data
      var temp_json;	

		// Create graph with appropriate formatting
		var ctx = document.getElementById('myChart').getContext('2d');
		var config = {
			type: 'scatter',
			data: {
				datasets: [{
					label: 'Temp Line',
					fill: false,
					pointRadius: 2,
					pointBorderWidth: 0,
					pointBackgroundColor: 'rgba(255,255,255,1)',
					showLine: true,
					borderColor: 'rgba(255,255,255,1)',
					borderWidth: 2,
					cubicInterpolationMode: 'monotone',
				}]
			},
			options: {
				animation: {
					duration: 0,
				},
				legend: {
					display: false,
				},
				scales: {
					yAxes: [{
						type: 'linear',
						ticks: {
							suggestedMin: 16,
							suggestedMax: 40,
							fontColor: 'rgba(255,255,255,0.7)',
							fontFamily: 'Open Sans',
							fontSize: 16,
							padding: 15,
							callback: function(value, index, values){
                     	return value + '¬∞';
                    	},
						},
						gridLines: {
							color: 'rgba(255,255,255,0.5)',
							lineWidth: 1,
							drawBorder: false,
						}
					}],
					xAxes: [{
						type: 'time',
						time: {
                     unit: 'hour'
						},
						gridLines: {
							color: 'rgba(255,255,255,0.5)',
							lineWidth: 1,
							drawBorder: false,
						},
						ticks: {
							fontColor: 'rgba(255,255,255,0.7)',
							fontFamily: 'Open Sans',
							fontSize: 16,
							padding: 15,
						}
					}],
				},
			}
		};

		// Initiate chart
      var chart = new Chart(ctx, config);
      
      

      // Fetch data
      function load_data(display_date){

         getCORS('https://mqtt.designedbycave.co.uk/temps/'+display_date.toISOString().substr(0,10), function(request){
            var data = request.currentTarget.response || request.target.responseText;
                     
            // Get temperature pairs
            temp_json = JSON.parse(data);

            // Create map function to get x,y values from temperature and timestamp
            var points = temp_json.map(function(e) {
               return {
                  x: new Date(e.ts*1000),
                  y: e.value
               };
            });

            // Update graph with temperature data
            chart.data.datasets[0].data = points;
            chart.update();
         });
      }

		// CORS function from https://plainjs.com/javascript/ajax/making-cors-ajax-get-requests-54/
		function getCORS(url, success) {
			var xhr = new XMLHttpRequest();
			if (!('withCredentials' in xhr)) xhr = new XDomainRequest(); // fix IE8/9
			xhr.open('GET', url);
			xhr.onload = success;
			xhr.send();
			return xhr;
      }
      
      // Reference for today's date
      var display_date = new Date();

      // Do initial data load
      set_date_label(display_date);
      load_data(display_date);


      // event handler function
      function handler(e) {
         var key = window.event ? e.keyCode : e.which;
         if(key == 37){
            // back a day
            display_date.setDate(display_date.getDate()-1);

            set_date_label(display_date);
            load_data(display_date);
         }else if(key == 39){
            // forward a day
            display_date.setDate(display_date.getDate()+1);

            set_date_label(display_date);
            load_data(display_date);
         }
      }

      function set_date_label(input_date){

         // WHAT A MESS!!
         var input_string = input_date.toISOString().substr(0,10);
         var today = new Date();
         var today_string = today.toISOString().substr(0,10);
         var yesterday = new Date();
         yesterday.setDate(today.getDate()-1);
         var yesterday_string = yesterday.toISOString().substr(0,10);

         var label_div = document.getElementById('date_title');

         // Compare
         if(input_date.getTime() > today.getTime()){
            label_div.innerHTML = "FUTURE";
         }else if(input_string === today_string) {
            label_div.innerHTML = "TODAY";
         }else if( yesterday_string == input_string){
            label_div.innerHTML = "YESTERDAY";
         }else if( today.getMonth() == input_date.getMonth()){
            label_div.innerHTML = getOrdinalNum(input_date.getDate());
         }else if( today.getFullYear() == input_date.getFullYear()){
            label_div.innerHTML = getOrdinalNum(input_date.getDate()) + " " + months[input_date.getMonth()];
         }else{
            label_div.innerHTML = getOrdinalNum(input_date.getDate()) + " " + months[input_date.getMonth()] + input_date.getFullYear();
         }
      }
      
      function getOrdinalNum(n) {
         return n + (n > 0 ? ['th', 'st', 'nd', 'rd'][(n > 3 && n < 21) || n % 10 > 3 ? 0 : n % 10] : '');
      }
      const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

      // attach handler to the keydown event of the document
      if (document.attachEvent) document.attachEvent('onkeydown', handler);
      else document.addEventListener('keydown', handler);

		</script>
			
	</body>

</html>